"use strict";var fs=require("fs"),Url=require("url");function XMLHttpRequest(f){f=f||{};var T,y,S=this,N=require("http"),R=require("https"),D={},r=!1,e={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},O=Object.assign({},e),n=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],o=["TRACE","TRACK","CONNECT"],g=!1,v=!1,a={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null;this.open=function(e,t,s,r,n){if(this.abort(),v=!1,!(a=e)||-1!==o.indexOf(a))throw"SecurityError: Request method not allowed";var a;D={method:e,url:t.toString(),async:"boolean"!=typeof s||s,user:r||null,password:n||null},x(this.OPENED)},this.setDisableHeaderCheck=function(e){r=e},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(s=e,!(r||s&&-1===n.indexOf(s.toLowerCase())))return console.warn('Refused to set unsafe header "'+e+'"'),!1;var s;if(g)throw"INVALID_STATE_ERR: send flag is true";return O[e]=t,!0},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&y.headers[e.toLowerCase()]&&!v?y.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||v)return"";var e="";for(var t in y.headers)"set-cookie"!==t&&"set-cookie2"!==t&&(e+=t+": "+y.headers[t]+"\r\n");return e.substr(0,e.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&O[e]?O[e]:""},this.send=function(e){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(g)throw"INVALID_STATE_ERR: send has already been called";var n,a=!1,t=!1,s=Url.parse(D.url);switch(s.protocol){case"https:":a=!0;case"http:":n=s.hostname;break;case"file:":t=!0;break;case void 0:case"":n="localhost";break;default:throw"Protocol not supported."}if(t){if("GET"!==D.method)throw"XMLHttpRequest: Only GET method is supported";if(D.async)fs.readFile(s.pathname,"utf8",function(e,t){e?S.handleError(e):(S.status=200,S.responseText=t,x(S.DONE))});else try{this.responseText=fs.readFileSync(s.pathname,"utf8"),this.status=200,x(S.DONE)}catch(e){this.handleError(e)}}else{var r=s.port||(a?443:80),o=s.pathname+(s.search?s.search:"");if(O.Host=n,a&&443===r||80===r||(O.Host+=":"+s.port),D.user){void 0===D.password&&(D.password="");var i=new Buffer(D.user+":"+D.password);O.Authorization="Basic "+i.toString("base64")}"GET"===D.method||"HEAD"===D.method?e=null:e?(O["Content-Length"]=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e),O["Content-Type"]||(O["Content-Type"]="text/plain;charset=UTF-8")):"POST"===D.method&&(O["Content-Length"]=0);var h=f.agent||!1,c={host:n,port:r,path:o,method:D.method,headers:O,agent:h};if(a&&(c.pfx=f.pfx,c.key=f.key,c.passphrase=f.passphrase,c.cert=f.cert,c.ca=f.ca,c.ciphers=f.ciphers,c.rejectUnauthorized=f.rejectUnauthorized),v=!1,D.async){var d=a?R.request:N.request;g=!0,S.dispatchEvent("readystatechange");var u=function(e){S.handleError(e)};T=d(c,function e(t){if(302===(y=t).statusCode||303===y.statusCode||307===y.statusCode){D.url=y.headers.location;var s=Url.parse(D.url);n=s.hostname;var r={hostname:s.hostname,port:s.port,path:s.path,method:303===y.statusCode?"GET":D.method,headers:O};return a&&(r.pfx=f.pfx,r.key=f.key,r.passphrase=f.passphrase,r.cert=f.cert,r.ca=f.ca,r.ciphers=f.ciphers,r.rejectUnauthorized=f.rejectUnauthorized),void(T=d(r,e).on("error",u)).end()}y&&y.setEncoding&&y.setEncoding("utf8"),x(S.HEADERS_RECEIVED),S.status=y.statusCode,y.on("data",function(e){e&&(S.responseText+=e),g&&x(S.LOADING)}),y.on("end",function(){g&&(g=!1,x(S.DONE))}),y.on("error",function(e){S.handleError(e)})}).on("error",u),e&&T.write(e),T.end(),S.dispatchEvent("loadstart")}else{var p=".node-xmlhttprequest-content-"+process.pid,E=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(E,"","utf8");for(JSON.stringify(c),e&&e.replace(/'/g,"\\'");fs.existsSync(E););if(S.responseText=fs.readFileSync(p,"utf8"),fs.unlinkSync(p),S.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var l=S.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,"");S.handleError(l)}else S.status=S.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),S.responseText=S.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),x(S.DONE)}}},this.handleError=function(e){this.status=503,this.statusText=e,this.responseText=e.stack,v=!0,x(this.DONE)},this.abort=function(){T&&(T.abort(),T=null),O=Object.assign({},e),this.responseText="",this.responseXML="",v=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!g||this.readyState===this.DONE||(g=!1,x(this.DONE)),this.readyState=this.UNSENT},this.addEventListener=function(e,t){e in a||(a[e]=[]),a[e].push(t)},this.removeEventListener=function(e,t){e in a&&(a[e]=a[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(e){if("function"==typeof S["on"+e]&&S["on"+e](),e in a)for(var t=0,s=a[e].length;t<s;t++)a[e][t].call(S)};var x=function(e){S.readyState!==e&&(S.readyState=e,(D.async||S.readyState<S.OPENED||S.readyState===S.DONE)&&S.dispatchEvent("readystatechange"),S.readyState!==S.DONE||v||(S.dispatchEvent("load"),S.dispatchEvent("loadend")))}}module.exports=XMLHttpRequest;