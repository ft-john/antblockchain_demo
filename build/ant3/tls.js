"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(e){_defineProperty(t,e,r[e])})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var tls=require("tls"),Errors=require("./errors"),Util=require("./util"),TLS=function(){function f(e,t){var r=e.host,n=e.port,o=e.clients,c=e.timeout,s=e.cert,i=e.ca,a=e.key,l=e.passphrase,u=e.checkServerIdentity,h=e.sendCallback;_classCallCheck(this,f),this.callback=t,this.sendCallback=h||"",this.retryNum=0,r&&n?(Array.isArray(o)||(o=[]),o=[{host:r,port:n}].concat(o)):Array.isArray(o)&&o.length&&(r=o[0].host,n=o[0].port),this.clients=o||[],this.currentClient=0,this.resetConnect({host:r,port:n,timeout:c,cert:s,ca:i,key:a,passphrase:l,checkServerIdentity:u})}return _createClass(f,[{key:"doCallback",value:function(e,t){"function"==typeof this.callback&&this.callback(e,t)}},{key:"setConfig",value:function(e){var t=e.host,r=e.port,n=e.timeout,o=e.cert,c=e.ca,s=e.key,i=e.passphrase,a=e.checkServerIdentity;this.host=t||"localhost",this.port=r||"18130",this.timeout=n||3e4,this.cert=o||"",this.ca=c||"",this.key=s||"",this.passphrase=i||"",this.checkServerIdentity=a}},{key:"connect",value:function(){var e=this,t=tls.createSecureContext({cert:this.cert,ca:[this.ca],key:this.key,passphrase:this.passphrase,ciphers:"ALL",ecdhCurve:"secp256k1"}),r={host:this.host,port:this.port,secureContext:t};this.checkServerIdentity||(r.checkServerIdentity=function(){});var n=tls.connect(r,function(){n.authorized?(e.retryNum=0,e.doCallback()):e.doCallback(Errors.unauthorized)});return n}},{key:"resetConnect",value:function(r){var o=this;this.setConfig(r),this.socket=this.connect();var c=null;this.socket.on("readable",function(e){if(c||(c=o.socket.read(Util.HEADER_LEN)),c){var t=Util.getTotalLength(c)-Util.HEADER_LEN,r=o.socket.read(t);if(r){var n=Util.getTlsPacket(c,r);c=null,"function"==typeof o.sendCallback&&o.sendCallback(e,n.data)}}}),this.socket.on("close",function(e){if(console.log("close",e),o.retryNum<4)o.retryNum++,setTimeout(function(){o.resetConnect(r)},1e3);else{o.currentClient++;var t=o.clients[o.currentClient];t&&setTimeout(function(){o.retryNum=0,o.resetConnect(_objectSpread({},r,{host:t.host,port:t.port}))},1e3)}}),this.socket.on("error",function(e){console.log("error",e)})}},{key:"send",value:function(e){var t=Util.makeTlsPacket(e);this.socket.write(t,"buffer",function(){})}}]),f}();module.exports=function(e,t){return new TLS(e,t)};