"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var Errors=require("./errors"),XMLHttpRequest=null;XMLHttpRequest="undefined"!=typeof window&&window.XMLHttpRequest?window.XMLHttpRequest:"undefined"!=typeof my?require("./myRequest"):require("./utils/httpRequest");var Request=function(){function h(e){var t=e.host,s=e.port,r=e.clients,n=e.headers,i=e.timeout,o=e.cert,a=e.ca,c=e.key,u=e.passphrase;_classCallCheck(this,h),t&&s?(Array.isArray(r)||(r=[]),r=[{host:t,port:s}].concat(r)):Array.isArray(r)&&r.length&&(t=r[0].host,s=r[0].port),this.clients=r||[],this.currentClient=0,this.resetConnect({host:t,port:s,headers:n,timeout:i,cert:o,ca:a,key:c,passphrase:u})}return _createClass(h,[{key:"open",value:function(){var t=new XMLHttpRequest({cert:this.cert,ca:this.ca,key:this.key,passphrase:this.passphrase,ciphers:"ALL",ecdhCurve:"secp256k1"});return t.withCredentials=!0,t.open("POST",this.host,!0),t.timeout=this.timeout,t.setRequestHeader("Content-Type","application/json"),this.headers&&this.headers.forEach(function(e){t.setRequestHeader(e.name,e.value)}),this.request=t}},{key:"setConfig",value:function(e){var t=e.host,s=e.port,r=e.headers,n=e.timeout,i=e.cert,o=e.ca,a=e.key,c=e.passphrase,u=t+":"+s;this.host=u||"http://localhost:7001",this.headers=r,this.timeout=n||5e3,this.cert=i||"",this.ca=o||"",this.key=a||"",this.passphrase=c||""}},{key:"resetConnect",value:function(e){this.setConfig(e)}},{key:"send",value:function(r,n){var i=this,o=this.open();try{o.send(JSON.stringify(r))}catch(e){return void n(Errors.connection(this.host))}o.onreadystatechange=function(){if(4===o.readyState&&1!==o.timeout){var e=o.responseText,t=null;if(200===o.status)try{e=JSON.parse(e)}catch(e){t=Errors.response()}else{i.currentClient++;var s=i.clients[i.currentClient];if(s)return void setTimeout(function(){i.resetConnect({host:s.host,port:s.port,headers:i.headers,timeout:i.timeout,cert:i.cert,ca:i.ca,key:i.key,passphrase:i.passphrase}),i.send(r,n)},1e3);t=Errors.connection(i.host),e={}}n(t,e)}},o.ontimeout=function(){n(Errors.timeout())}}}]),h}();module.exports=Request;